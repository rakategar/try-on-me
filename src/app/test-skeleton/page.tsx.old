'use client';

import { useEffect, useRef, useState } from 'react';
import Image from 'next/image';

export default function TestSkeletonPage() {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const resultCanvasRef = useRef<HTMLCanvasElement>(null); // Canvas untuk download
  const imageRef = useRef<HTMLImageElement>(null);
  const [status, setStatus] = useState('Loading...');
  const [imageLoaded, setImageLoaded] = useState(false);
  const [canvasReady, setCanvasReady] = useState(false);

  useEffect(() => {
    if (!canvasRef.current || !imageRef.current || !resultCanvasRef.current) return;

    const canvas = canvasRef.current;
    const resultCanvas = resultCanvasRef.current;
    const ctx = canvas.getContext('2d');
    const resultCtx = resultCanvas.getContext('2d');
    const img = imageRef.current;

    if (!ctx || !resultCtx) return;

    const drawSkeletonOnImage = () => {
      if (!imageLoaded) {
        console.log('Image not loaded yet');
        return;
      }

      // Set canvas size to match image
      canvas.width = img.naturalWidth || img.width;
      canvas.height = img.naturalHeight || img.height;
      resultCanvas.width = img.naturalWidth || img.width;
      resultCanvas.height = img.naturalHeight || img.height;

      const w = canvas.width;
      const h = canvas.height;

      console.log('Canvas size:', w, 'x', h);
      console.log('Image natural size:', img.naturalWidth, 'x', img.naturalHeight);
      console.log('Image display size:', img.width, 'x', img.height);

      // Clear canvases
      ctx.clearRect(0, 0, w, h);
      resultCtx.clearRect(0, 0, w, h);

      // Draw original image on result canvas first
      resultCtx.drawImage(img, 0, 0, w, h);
      console.log('Image drawn on result canvas');

      // Pose landmarks berdasarkan proporsi tubuh manusia dalam foto
      // Koordinat disesuaikan dengan posisi tubuh di gambar
      const landmarks = [
        { name: 'nose', x: 0.5, y: 0.12 },
        { name: 'left_eye', x: 0.48, y: 0.10 },
        { name: 'right_eye', x: 0.52, y: 0.10 },
        { name: 'left_ear', x: 0.46, y: 0.11 },
        { name: 'right_ear', x: 0.54, y: 0.11 },
        { name: 'left_shoulder', x: 0.42, y: 0.22 },
        { name: 'right_shoulder', x: 0.58, y: 0.22 },
        { name: 'left_elbow', x: 0.38, y: 0.35 },
        { name: 'right_elbow', x: 0.62, y: 0.35 },
        { name: 'left_wrist', x: 0.36, y: 0.48 },
        { name: 'right_wrist', x: 0.64, y: 0.48 },
        { name: 'left_hip', x: 0.45, y: 0.52 },
        { name: 'right_hip', x: 0.55, y: 0.52 },
        { name: 'left_knee', x: 0.45, y: 0.72 },
        { name: 'right_knee', x: 0.55, y: 0.72 },
        { name: 'left_ankle', x: 0.45, y: 0.92 },
        { name: 'right_ankle', x: 0.55, y: 0.92 },
      ];

      // Convert to pixel coordinates
      const points = landmarks.map(lm => ({
        name: lm.name,
        x: lm.x * w,
        y: lm.y * h
      }));

      // Draw skeleton connections
      const connections = [
        // Face
        [1, 3], [2, 4], [0, 1], [0, 2],
        // Upper body
        [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],
        // Torso
        [5, 11], [6, 12], [11, 12],
        // Lower body
        [11, 13], [13, 15], [12, 14], [14, 16],
      ];

      // Draw lines (skeleton) on BOTH canvases
      [ctx, resultCtx].forEach(context => {
        context.strokeStyle = '#00ff00';
        context.lineWidth = 6;
        context.shadowColor = '#000000';
        context.shadowBlur = 4;
        connections.forEach(([i, j]) => {
          const p1 = points[i];
          const p2 = points[j];
          if (p1 && p2) {
            context.beginPath();
            context.moveTo(p1.x, p1.y);
            context.lineTo(p2.x, p2.y);
            context.stroke();
          }
        });
      });

      // Draw points (joints) on BOTH canvases
      [ctx, resultCtx].forEach(context => {
        points.forEach((point, idx) => {
          // Different colors for different body parts
          if (idx < 5) {
            context.fillStyle = '#ff00ff'; // Face - magenta
            context.strokeStyle = '#ffffff';
          } else if (idx < 11) {
            context.fillStyle = '#00ffff'; // Arms - cyan
            context.strokeStyle = '#ffffff';
          } else if (idx < 13) {
            context.fillStyle = '#ffff00'; // Hips - yellow
            context.strokeStyle = '#ffffff';
          } else {
            context.fillStyle = '#ff6600'; // Legs - orange
            context.strokeStyle = '#ffffff';
          }
          
          context.lineWidth = 3;
          context.beginPath();
          context.arc(point.x, point.y, 12, 0, 2 * Math.PI);
          context.fill();
          context.stroke();
          
          // Draw point labels
          context.fillStyle = '#ffffff';
          context.strokeStyle = '#000000';
          context.lineWidth = 3;
          context.font = 'bold 16px Arial';
          context.strokeText(point.name, point.x + 15, point.y + 5);
          context.fillText(point.name, point.x + 15, point.y + 5);
        });
      });

      setStatus('âœ… Skeleton rendered! ' + points.length + ' points');
      setCanvasReady(true);
      console.log('Skeleton drawing complete on both canvases!');
    };

    // Draw when image loads
    if (imageLoaded) {
      setTimeout(drawSkeletonOnImage, 100);
    }
  }, [imageLoaded]);

  const handleImageLoad = () => {
    console.log('Image loaded successfully');
    setImageLoaded(true);
    setStatus('Image loaded, drawing skeleton...');
  };

  const handleDownload = () => {
    if (!resultCanvasRef.current) {
      alert('Canvas belum siap!');
      return;
    }

    try {
      // Convert canvas to blob
      resultCanvasRef.current.toBlob((blob) => {
        if (!blob) {
          alert('Gagal membuat image!');
          return;
        }

        // Create download link
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const timestamp = new Date().getTime();
        link.download = `skeleton-result-${timestamp}.png`;
        link.href = url;
        link.click();
        
        // Cleanup
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        console.log('Download complete!');
        setStatus('âœ… Downloaded skeleton-result-' + timestamp + '.png');
      }, 'image/png');
    } catch (error) {
      console.error('Download error:', error);
      alert('Error saat download: ' + error);
    }
  };

  const handleDownloadOverlayOnly = () => {
    if (!canvasRef.current) {
      alert('Canvas belum siap!');
      return;
    }

    try {
      const url = canvasRef.current.toDataURL('image/png');
      const link = document.createElement('a');
      const timestamp = new Date().getTime();
      link.download = `skeleton-overlay-${timestamp}.png`;
      link.href = url;
      link.click();
      
      console.log('Download overlay complete!');
      setStatus('âœ… Downloaded skeleton-overlay-' + timestamp + '.png');
    } catch (error) {
      console.error('Download error:', error);
      alert('Error saat download: ' + error);
    }
  };

  return (
    <div className="min-h-screen bg-gray-900 p-4">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold text-white mb-4">
          ğŸ¯ Test Skeleton Detection
        </h1>
        
        <div className="bg-black/50 text-white p-4 rounded mb-4">
          <div className="text-lg font-bold">Status: {status}</div>
          <div className="mt-2 text-sm">
            <div>ğŸ’œ Magenta = Face (hidung, mata, telinga)</div>
            <div>ğŸ’™ Cyan = Arms (bahu, siku, pergelangan tangan)</div>
            <div>ğŸ’› Yellow = Hips (pinggul)</div>
            <div>ğŸ§¡ Orange = Legs (lutut, pergelangan kaki)</div>
            <div className="mt-2">ğŸŸ¢ Green lines = Skeleton connections</div>
          </div>
          
          {/* Download Buttons */}
          <div className="mt-4 flex gap-3 flex-wrap">
            <button
              onClick={handleDownload}
              disabled={!canvasReady}
              className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                canvasReady
                  ? 'bg-green-600 hover:bg-green-700 text-white shadow-lg hover:shadow-xl'
                  : 'bg-gray-600 text-gray-400 cursor-not-allowed'
              }`}
            >
              ğŸ“¥ Download Hasil (Gambar + Skeleton)
            </button>
            
            <button
              onClick={handleDownloadOverlayOnly}
              disabled={!canvasReady}
              className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                canvasReady
                  ? 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-xl'
                  : 'bg-gray-600 text-gray-400 cursor-not-allowed'
              }`}
            >
              ğŸ“¥ Download Skeleton Only (Transparan)
            </button>
          </div>
        </div>

        <div className="relative bg-white rounded-lg overflow-hidden">
          {/* Original Image */}
          <img
            ref={imageRef}
            src="/test-image.jpg"
            alt="Test pose"
            className="w-full h-auto"
            onLoad={handleImageLoad}
            onError={() => {
              setStatus('âŒ Error loading image. Make sure /public/test-image.jpg exists');
            }}
          />
          
          {/* Skeleton Overlay Canvas */}
          <canvas
            ref={canvasRef}
            className="absolute top-0 left-0 w-full h-full pointer-events-none"
            style={{ opacity: 0.9 }}
          />
        </div>

        {/* Hidden canvas for download (contains image + skeleton) */}
        <canvas
          ref={resultCanvasRef}
          className="hidden"
          style={{ display: 'none' }}
        />

        <div className="mt-4 bg-blue-900 text-white p-4 rounded">
          <h2 className="font-bold text-xl mb-3">ğŸ“‹ Cara melihat hasil:</h2>
          <ol className="list-decimal list-inside space-y-2 text-sm">
            <li>Upload gambar Anda sebagai <code className="bg-black/30 px-2 py-1 rounded">/public/test-image.jpg</code></li>
            <li>Skeleton akan otomatis muncul di atas gambar dalam <strong>2-3 detik</strong></li>
            <li>Klik tombol <strong className="text-green-300">ğŸ“¥ Download Hasil</strong> untuk download gambar + skeleton</li>
            <li>Atau klik <strong className="text-blue-300">ğŸ“¥ Download Skeleton Only</strong> untuk skeleton transparan saja</li>
          </ol>
          
          <div className="mt-4 pt-4 border-t border-blue-700">
            <h3 className="font-bold mb-2">ğŸ”§ Troubleshooting:</h3>
            <ul className="text-sm space-y-1">
              <li>âŒ Jika skeleton tidak muncul: Buka Browser Console (F12) untuk lihat log</li>
              <li>âŒ Jika gambar tidak muncul: Pastikan file <code className="bg-black/30 px-1">/public/test-image.jpg</code> ada</li>
              <li>âœ… Tombol download akan aktif (hijau/biru) setelah skeleton selesai di-render</li>
              <li>âœ… File download akan tersimpan di folder Downloads dengan nama <code className="bg-black/30 px-1">skeleton-result-[timestamp].png</code></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}
